doctype html
html(lang="ko")
    head
        meta(charset='utf-8')
        title MBTI Guestbook
        meta(name='viewport', content='width=device-width, initial-scale=1')
        
        link(rel='stylesheet', href='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css')
        link(rel='preconnect', href='https://fonts.googleapis.com')
        link(rel='preconnect', href='https://fonts.gstatic.com', crossorigin)
        link(href='https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap', rel='stylesheet')

        style.
            body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #343a40; }
            .header { background-color: #ffffff; padding: 2rem 0; border-bottom: 1px solid #dee2e6; margin-bottom: 2rem; }
            .test-container { background-color: #ffffff; border-radius: 15px; padding: 2rem 2.5rem; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); margin-bottom: 2rem; }
            .question-block { margin-bottom: 1.75rem; }
            .card { border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); border: none; }
            .modal-content { border-radius: 15px; }

    body
        .header
            .container.text-center
                h1: a(href='/') ë‹¹ì‹ ì˜ MBTIë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”
                div.mt-2
                    a(href='/saju').text-muted.mr-3 ì‚¬ì£¼ ë³´ê¸°
                    button#showResultBtn.btn.btn-sm.btn-outline-info(type="button", style="display:none;") ë‚´ ê²°ê³¼ ë‹¤ì‹œë³´ê¸°
                    button#debugFillBtn.btn.btn-sm.btn-warning.mt-2(type="button") [Debug: Auto-Fill]

        .container
            .test-container
                form#mbtiForm(action="/post", method="POST")
                    .d-flex.justify-content-between.align-items-center.mb-2
                        h5 ì§„í–‰ ìƒí™©
                        h5#questionCounter (0 / 20)
                    .progress.mb-4(style="height: 20px;")
                        #progressBar.progress-bar.bg-success.progress-bar-striped.progress-bar-animated(role="progressbar", style="width: 0%;") 0%
                    
                    hr.my-4
                    -

                        let q_index = 0;

                    each categoryQuestions, category in questions
                        fieldset.my-4
                            legend.h5.mb-3 #{category}
                            each question in categoryQuestions
                                - q_index++
                                .question-block
                                    p #{q_index}. #{question}
                                    .btn-group.btn-group-toggle(data-toggle="buttons")
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="-2", required)
                                            span ë§¤ìš° ì•„ë‹ˆë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="-1")
                                            span ì•„ë‹ˆë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="0")
                                            span ë³´í†µ
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="1")
                                            span ê·¸ë ‡ë‹¤
                                        label.btn.btn-outline-secondary
                                            input(type="radio", name=`q${q_index}`, value="2")
                                            span ë§¤ìš° ê·¸ë ‡ë‹¤
                    
                    input(type="hidden", name="mbti", id="mbtiResultInput")
                    input(type="hidden", name="scoreE", id="scoreE")
                    input(type="hidden", name="scoreS", id="scoreS")
                    input(type="hidden", name="scoreT", id="scoreT")
                    input(type="hidden", name="scoreJ", id="scoreJ")
                    
                    hr.my-4

                    .text-center.mt-4
                        button#calculateBtn.btn.btn-info.btn-lg(type="button", disabled) ê²°ê³¼ ë³´ê¸°

                    div#final-inputs(style="display:none;")
                        hr.my-4
                        h5.text-center.mb-3 ë§ˆì§€ë§‰ìœ¼ë¡œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                        .row.justify-content-center
                            .col-md-5.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text Writer
                                    input#name.form-control(type="text", name="name", placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", required)
                            .col-md-5.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text Date
                                    input#date.form-control(type="date", name="date", required)
                        .row.justify-content-center
                            .col-md-10.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text í•œë§ˆë””
                                    input.form-control(type="text", name="memo", placeholder="ê²°ê³¼ì— ëŒ€í•œ ì†Œê°ì„ ë‚¨ê²¨ë³´ì„¸ìš”! (ì„ íƒ)")
                        .row.justify-content-center
                            .col-md-10.mb-3
                                .input-group
                                    .input-group-prepend
                                        span.input-group-text íƒœê·¸
                                    input.form-control(type="text", name="tags", placeholder="ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ìì‹ ì„ í‘œí˜„í•´ë³´ì„¸ìš”.")
                        .text-center.mt-4
                            button#submitBtn.btn.btn-primary.btn-lg(type="submit", disabled) ê²°ê³¼ ì €ì¥í•˜ê¸°
            hr

            section#post-list
                if messages && messages.length > 0
                    h2.text-center.mb-4 ë°©ë¬¸ì ê¸°ë¡
                    .row
                        each msg in messages
                            .col-md-6.col-lg-4.mb-4
                                .card
                                    .card-body
                                        h5.card-title #{msg.name}
                                        p.card-text.mt-3
                                            strong MBTI ê²°ê³¼: 
                                            span.badge.badge-success.p-2 #{msg.mbti}
                                        if msg.memo
                                            p.card-text.font-italic.mt-2
                                                | "#{msg.memo}"
                                        if msg.tags && msg.tags.length > 0
                                            div.mt-2
                                                each tag in msg.tags
                                                    span.badge.badge-pill.badge-info.mr-1 #{tag}
                                        hr
                                        div.d-flex.justify-content-between.align-items-center
                                            small.text-muted #{new Date(msg.createdAt).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
                                            div
                                                span.mr-1(id=`likes-count-${msg._id}`) #{msg.likes || 0}
                                                button.btn.btn-sm.btn-outline-danger.like-button(type="button", data-id=msg._id) â¤ï¸
                else
                    .alert.alert-info(role='alert')
                        | ì•„ì§ ë“±ë¡ëœ ë°©ëª…ë¡ì´ ì—†ìŠµë‹ˆë‹¤.

        #resultModal.modal.fade(tabindex="-1", role="dialog")
            .modal-dialog.modal-dialog-centered(role="document")
                .modal-content
                    .modal-header
                        h5.modal-title ğŸ‰ ë‹¹ì‹ ì˜ MBTI ê²°ê³¼ì…ë‹ˆë‹¤!
                        button.close(type="button", data-dismiss="modal"): span(aria-hidden="true") &times;
                    .modal-body.text-center
                        p.lead ë‹¹ì‹ ì˜ ì„±í–¥ì„ ë‚˜íƒ€ë‚´ëŠ” ìœ í˜•ì€...
                        h1#modalResultText.font-weight-bold
                    .modal-footer
                        button.btn.btn-secondary(type="button", data-dismiss="modal") ë‹«ê¸°

        script(src='https://code.jquery.com/jquery-3.5.1.slim.min.js')
        script(src='https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js')
        script(src='https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js')

        script.
            document.addEventListener('DOMContentLoaded', () => {
                const totalQuestions = 100;
                const mbtiForm = document.getElementById('mbtiForm');
                const debugFillBtn = document.getElementById('debugFillBtn'); // ğŸŒŸ ë””ë²„ê·¸ ë²„íŠ¼ ë³€ìˆ˜
                const progressBar = document.getElementById('progressBar');
                const nameInput = document.getElementById('name');
                const dateInput = document.getElementById('date');
                const mbtiResultInput = document.getElementById('mbtiResultInput');
                const calculateBtn = document.getElementById('calculateBtn');
                const finalInputs = document.getElementById('final-inputs');
                const submitBtn = document.getElementById('submitBtn');
                const showResultBtn = document.getElementById('showResultBtn');
                const modalResultText = document.getElementById('modalResultText');
                const questionCounter = document.getElementById('questionCounter');

                const allRadios = document.querySelectorAll('input[type="radio"]');
                allRadios.forEach(radio => {
                    radio.addEventListener('click', () => {
                        updateProgress();
                        checkCompletion();
                    });
                });
                
                nameInput.addEventListener('input', checkCompletion);
                dateInput.addEventListener('input', checkCompletion);

                if (localStorage.getItem('userMBTI')) {
                    showResultBtn.style.display = 'inline-block';
                }
                debugFillBtn.addEventListener('click', () => {
                        console.log('[DEBUG] Auto-filling all questions...');
                        // ëª¨ë“  ì§ˆë¬¸ì— ëŒ€í•´ 'ë§¤ìš° ê·¸ë ‡ë‹¤' (value="2")ë¥¼ ì„ íƒí•˜ë„ë¡ ì‹œë®¬ë ˆì´ì…˜
                        for (let i = 1; i <= totalQuestions; i++) {
                            const radioToSelect = document.querySelector(`input[name="q${i}"][value="2"]`);
                            if (radioToSelect) {
                                // ì´ë¯¸ ì„ íƒëœ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
                                if (!radioToSelect.checked) {
                                    radioToSelect.click(); // 'click'ì„ í˜¸ì¶œí•˜ì—¬ change ì´ë²¤íŠ¸ë„ íŠ¸ë¦¬ê±°
                                }
                            }
                        }
                        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ë° ì™„ë£Œ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œ
                        updateProgress();
                        checkCompletion();
                        console.log('[DEBUG] Auto-fill complete.');
                        // í•„ìš”í•˜ë‹¤ë©´ ìë™ìœ¼ë¡œ 'ê²°ê³¼ ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ë„ ì¶”ê°€ ê°€ëŠ¥
                        // if (!calculateBtn.disabled) {
                        //     calculateBtn.click();
                        // }
                    });
                calculateBtn.addEventListener('click', () => {
                    const result = calculateMBTI();
                    mbtiResultInput.value = result;
                    localStorage.setItem('userMBTI', result);
                    showResultModal(result);
                    finalInputs.style.display = 'block';
                    calculateBtn.style.display = 'none';
                    showResultBtn.style.display = 'inline-block';
                });
                
                showResultBtn.addEventListener('click', () => {
                    const result = localStorage.getItem('userMBTI');
                    if (result) showResultModal(result);
                });
                
                function updateProgress() {
                    const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
                    const answeredCount = checkedRadios.length;
                    const progress = (answeredCount / totalQuestions) * 100;
                    
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    questionCounter.textContent = `(${answeredCount} / ${totalQuestions})`;
                }

                function checkCompletion() {
                    const allQuestionsAnswered = document.querySelectorAll('input[type="radio"]:checked').length === totalQuestions;
                    calculateBtn.disabled = !allQuestionsAnswered;
                    
                    const writerFilled = nameInput.value.trim() !== '';
                    const dateFilled = dateInput.value !== '';
                    submitBtn.disabled = !(allQuestionsAnswered && writerFilled && dateFilled);
                }

                function calculateMBTI() {
                    const scores = { E: 0, S: 0, T: 0, J: 0 };
                    const eiEnd = 26; // E/I ì§ˆë¬¸ ë ë²ˆí˜¸
                    const snEnd = eiEnd + 25; // S/N ì§ˆë¬¸ ë ë²ˆí˜¸
                    const tfEnd = snEnd + 24; // T/F ì§ˆë¬¸ ë ë²ˆí˜¸
                    const jpEnd = tfEnd + 25; // J/P ì§ˆë¬¸ ë ë²ˆí˜¸ (ì´ 100)
                        for (let i = 1; i <= jpEnd; i++) {
                        const radio = document.querySelector(`input[name="q${i}"]:checked`);
                        if(radio) {
                            const value = parseInt(radio.value);
                            if (i <= 5) scores.E += value;
                            if (i > 5 && i <= 10) scores.S += value;
                            if (i > 10 && i <= 15) scores.T += value;
                            if (i > 15 && i <= 20) scores.J += value;
                        }
                    }

                    document.getElementById('scoreE').value = scores.E;
                    document.getElementById('scoreS').value = scores.S;
                    document.getElementById('scoreT').value = scores.T;
                    document.getElementById('scoreJ').value = scores.J;

                    let result = '';
                    result += (scores.E > 0) ? 'E' : 'I';
                    result += (scores.S > 0) ? 'S' : 'N';
                    result += (scores.T > 0) ? 'T' : 'F';
                    result += (scores.J > 0) ? 'J' : 'P';
                    return result;
                }

                function showResultModal(result) {
                    modalResultText.textContent = result;
                    $('#resultModal').modal('show');
                }
                
                function initializeLikeButtons() {
                    const likeButtons = document.querySelectorAll('.like-button');
                    likeButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const messageId = button.dataset.id;
                            
                            fetch(`/like/${messageId}`, { method: 'POST' })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(updatedMessage => {
                                    const countSpan = document.getElementById(`likes-count-${messageId}`);
                                    if (countSpan) {
                                        countSpan.textContent = updatedMessage.likes;
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        });
                    });
                }
                
                initializeLikeButtons();
            });
